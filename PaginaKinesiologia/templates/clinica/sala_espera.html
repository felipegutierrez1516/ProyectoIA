{% extends 'base.html' %}
{% load static %}

{% block title %}Sala de Espera - {{ caso.titulo }}{% endblock %}

{% block extra_css %}
<style>
    /* Estilos UCN */
    .bg-ucn { background-color: #003057 !important; color: white; }
    .text-ucn { color: #003057 !important; }

    /* Contenedor */
    .sala-container {
        position: relative;
        width: 100%;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        background-color: #f0f0f0;
    }

    .sala-imagen {
        width: 100%;
        height: auto;
        display: block;
        min-height: 400px;
        object-fit: cover;
    }

    /* --- MARCADORES --- */
    .paciente-marker {
        position: absolute;
        top: 55%; 
        width: 50px;
        height: 50px;
        border-radius: 50%;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        z-index: 10;
        text-decoration: none;
    }

    /* Estado NORMAL (Azul) */
    .marker-pendiente {
        background-color: #003057;
    }
    .marker-pendiente:hover {
        transform: scale(1.15) translateY(-5px);
        background-color: #004a87;
    }

    /* Estado COMPLETADO (Verde) */
    .marker-completado {
        background-color: #28a745 !important; /* Verde éxito */
        border-color: #fff;
    }
    .marker-completado:hover {
        transform: scale(1.15) translateY(-5px);
        background-color: #218838 !important;
    }
    
    /* Animación solo para pendientes */
    .marker-pendiente::after {
        content: '';
        position: absolute;
        width: 100%; height: 100%;
        border-radius: 50%;
        border: 2px solid #003057;
        animation: pulse 2s infinite;
        opacity: 0;
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 0.8; }
        100% { transform: scale(1.6); opacity: 0; }
    }

    .list-group-item-active-custom {
        background-color: #e3f2fd;
        color: #003057;
        border-left: 4px solid #003057;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    
    <aside class="col-md-3">
        <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-ucn py-3">
                <h6 class="mb-0 fw-bold"><i class="bi bi-list-task me-2"></i>Casos Disponibles</h6>
            </div>
            <div class="list-group list-group-flush">
                {% if casos %}
                    {% for c in casos %}
                        <a href="{% url 'sala_espera' c.id %}" 
                           class="list-group-item list-group-item-action py-3 {% if c.id == caso.id %}list-group-item-active-custom{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>{{ c.titulo }}</span>
                                {% if c.id == caso.id %}
                                    <i class="bi bi-geo-alt-fill text-ucn"></i>
                                {% endif %}
                            </div>
                        </a>
                    {% endfor %}
                {% else %}
                    <div class="p-3 text-muted small">No hay otros casos disponibles.</div>
                {% endif %}
            </div>
        </div>
    </aside>

    <main class="col-md-9">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-1 small">
                        <li class="breadcrumb-item"><a href="{% url 'inicio_estudiante' %}" class="text-decoration-none text-muted">Inicio</a></li>
                        <li class="breadcrumb-item active text-ucn fw-bold" aria-current="page">Sala de Espera</li>
                    </ol>
                </nav>
            </div>
            <span class="badge bg-warning text-dark shadow-sm px-3 py-2 rounded-pill">
                <i class="bi bi-people-fill me-1"></i> Pacientes en espera
            </span>
        </div>

        <div class="alert alert-light border-start border-4 border-info shadow-sm mb-3">
            <i class="bi bi-info-circle-fill text-info me-2"></i>
            <span class="fw-semibold text-dark">Instrucción:</span> 
            Haz clic sobre uno de los iconos en la imagen para ver sus datos y comenzar la evaluación. Los pacientes en <span class="badge bg-primary">Azul</span> están pendientes, mientras que en <span class="badge bg-success">Verde</span> ya fueron evaluados.
        </div>

        <div class="card shadow border-0 p-2 rounded-3">
            <div class="sala-container">
                <img src="{% static 'img/sala_espera.png' %}" alt="Sala de Espera" class="sala-imagen">
                
                {% for paciente in pacientes %}
                    
                    {% if paciente.id in pacientes_evaluados %}
                        <a href="{% url 'motivo_consulta' paciente.id %}" 
                           class="paciente-marker marker-completado"
                           style="left: {% if forloop.counter == 1 %}15%{% elif forloop.counter == 2 %}32%{% elif forloop.counter == 3 %}49%{% elif forloop.counter == 4 %}66%{% else %}83%{% endif %};" 
                           data-bs-toggle="tooltip" data-bs-html="true" 
                           title="<strong>{{ paciente.nombre }}</strong><br>Evaluación Completada"
                           onclick="return confirm('Ya has realizado esta evaluación clínica. ¿Estás seguro de que quieres realizarla nuevamente?');">
                            <i class="bi bi-check-lg fs-4"></i>
                        </a>
                    {% else %}
                        <a href="{% url 'motivo_consulta' paciente.id %}" 
                           class="paciente-marker marker-pendiente"
                           style="left: {% if forloop.counter == 1 %}15%{% elif forloop.counter == 2 %}32%{% elif forloop.counter == 3 %}49%{% elif forloop.counter == 4 %}66%{% else %}83%{% endif %};" 
                           data-bs-toggle="tooltip" data-bs-html="true" 
                           title="<strong>{{ paciente.nombre }}</strong><br>{{ paciente.edad }} años">
                            <i class="bi bi-person-fill fs-4"></i>
                        </a>
                    {% endif %}

                {% endfor %}
            </div>
        </div>

        <div class="mt-3 mb-5">
            <a href="{% url 'inicio_estudiante' %}" class="btn btn-outline-secondary px-4">
                <i class="bi bi-arrow-left me-2"></i>Volver al Inicio
            </a>
        </div>

    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Inicializar Tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% endblock %}